<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="build_ngchm_all" basedir = "." name="Create a minimize javascript file for the widgetizer (ngchmWidget-min.js) AND the stand-alone Viewer (ngChmApp.html) file">

	<!-- Set variables for execution -->
	<property name="src.dir" value="mda.ngchm.util."/>
    <property name="web.dir" value="./WebContent/"/>
    <property name="js.dir" value="${web.dir}javascript/"/>
    <property name="dir.jarfile" value="./WebContent/WEB-INF/lib"/>
    <property name="java.dir" value="./src/mda/ngchm/util/"/>

	<!-- Execute a Javascript miminizer to generate a minified custom-min.js file -->
    <target name="minimize_custom_js">
	<apply executable="java" parallel="false">
	    <fileset dir="${js.dir}" includes="custom/custom.js"/>
	    <arg line="-jar"/>
	    <arg path="${dir.jarfile}/closure-compiler-v20200204.jar"/>
	    <srcfile/>
		<arg line="--js_output_file"/>
	    <mapper type="glob" from="*.js" to="${js.dir}*-min.js"/>
	    <targetfile/>
	</apply>
    </target>  
		
	<!-- Build all JAVA class files -->
    <target name="classfiles">
        <mkdir dir="build/classes"/>
        <javac srcdir="${java.dir}" destdir="build/classes" />
    </target>

	<!-- Execute the JAVA NGCHM_Minimizer to combine all JS files into a single ngchm.js file -->
    <target name="create_combined_js" depends="classfiles,minimize_custom_js">
	<java classname="${src.dir}NGCHM_Minimizer">
	    <arg value="${web.dir}"/>
	    <arg value="ngchm.js"/>
	    <classpath>
	        <pathelement path="build/classes"/>
	    </classpath>
	</java>
    </target>
	
	<!-- Execute a Javascript miminizer to generate a minified ngchm-min.js file -->
    <target name="minify_js" depends="create_combined_js">
        <apply executable="java" parallel="false">
            <fileset dir="${js.dir}" includes="ngchm.js"/>
            <arg line="-jar"/>
            <arg path="${dir.jarfile}/closure-compiler-v20200204.jar"/>
            <srcfile/>
            <arg line="--compilation_level"/>
            <arg line="SIMPLE_OPTIMIZATIONS"/>
            <arg line="--jscomp_off"/>
            <arg line="uselessCode"/>
            <arg line="--js_output_file"/>
            <mapper type="glob" from="*.js" to="${js.dir}*-min.js"/>
            <targetfile/>
        </apply>
    </target>  
	
	<!-- Execute a Javascript miminizer to generate a minified ngchmEmbed-min.js file -->
    <target name="minify_embedder_js">
	<apply executable="java" parallel="false">
	    <fileset dir="${js.dir}" includes="NGCHM_Embed.js"/>
	    <arg line="-jar"/>
	    <arg path="${dir.jarfile}/closure-compiler-v20200204.jar"/>
	    <srcfile/>
		<arg line="--js_output_file"/>
	    <mapper type="glob" from="*.js" to="ngchmEmbed-min.js"/>
	    <targetfile/>
	</apply>
    </target>  

	<!-- Execute the JAVA NGCHM_AppGenerator to create the stand-alone viewer ngChmApp.html file -->
	<target name="create_app_html" depends="classfiles,minify_js"> 
	<java classname="${src.dir}NGCHM_AppGenerator">
	    <arg value="${web.dir}"/>
	    <arg value="ngChmApp.html"/>
	    <classpath>
	        <pathelement path="build/classes"/>
	    </classpath>
	</java>
    </target>
	
	<!-- Execute the JAVA NGCHM_AppVersioner to update the version on all JS includes in chm.html -->
	<target name="version_app_html" depends="classfiles,minify_js"> 
	<java classname="${src.dir}NGCHM_AppVersioner">
	    <arg value="${web.dir}"/>
	    <classpath>
	        <pathelement path="build/classes"/>
	    </classpath>
	</java>
    </target>
	
	<!-- Execute the JAVA NGCHM_Widgetizer to create the ngchmWidget-min.js NG-CHM Widget file -->
    <target name="create_widget_js" depends="classfiles,minify_js,minify_embedder_js">
	<java classname="${src.dir}NGCHM_Widgetizer">
	    <arg value="${web.dir}"/>
	    <arg value="ngchmWidget-min.js"/>
	    <arg value="file"/>
	    <classpath>
	        <pathelement path="build/classes"/>
	    </classpath>
	</java>
    </target>
	
	<!-- Target to call the steps to build just the ngChmApp.html stand-alone viewer file -->
	<!-- It will delete any by-product JS files that are no longer needed -->
    <target name="build_ngchm_app" depends="create_app_html,version_app_html">
	<delete>
        	<fileset dir="${js.dir}" includes="ngchm.js"/>
            <fileset dir="${js.dir}" includes="ngchm-min.js"/>
            <fileset dir="${js.dir}" includes="custom/custom-min.js"/>
	</delete>
    </target>
	
	<!-- Target to call the steps to build just the ngchmWidget-min.js NG-CHM Widget file -->
	<!-- It will delete any by-product JS files that are no longer needed -->
    <target name="build_ngchm_widget" depends="create_widget_js,version_app_html">
	<delete>
    		<fileset dir="${js.dir}" includes="ngchm.js"/>
            <fileset dir="${js.dir}" includes="ngchm-min.js"/>
            <fileset dir="${js.dir}" includes="custom/custom-min.js"/>
	</delete>
    </target>

	<!-- Target to call the steps to build all NG-CHM components generated by this ANT script -->
	<!-- It will delete any by-product JS files that are no longer needed -->
    <target name="build_ngchm_all" depends="create_app_html,create_widget_js,version_app_html">
	<delete>
    		<fileset dir="${js.dir}" includes="ngchm.js"/>
            <fileset dir="${js.dir}" includes="ngchm-min.js"/>
            <fileset dir="${js.dir}" includes="custom/custom-min.js"/>
	</delete>
    <move file="${web.dir}chmTemp.html" tofile="${web.dir}chm.html"/>
    </target>

</project>

