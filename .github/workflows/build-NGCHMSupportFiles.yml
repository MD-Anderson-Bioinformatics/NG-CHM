##
##  GitHub Action to build artifacts for NGCHMSupportFiles,
##  triggered by publishing a release
##

name: Build artifacts for NGCHMSupportFiles
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  Build-ShaidyMapGen-and-ngchmWdiget-min:
    runs-on: ubuntu-22.04
    env:
      NGCHMSupportFiles_REPOSITORY: 'MD-Anderson-Bioinformatics/NGCHMSupportFiles'
      NGCHMSupportFiles_BRANCH: 'main'
      JAVA_VERSION: 11
      GIT_COMMIT: ${{ github.sha }}
      GIT_LATEST_TAG: ${{ github.ref }}
    steps:
      - name: Check out release tag
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
      # https://github.com/marohrdanz/extract-version-from-file
      # Output from this step is version from CompatibilityManager as 'version_number'.
      - name: Get version number
        id: get_version_number
        uses: marohrdanz/extract-version-from-file@v1.0.0
        with:
          file_path: 'NGCHM/WebContent/javascript/CompatibilityManager.js'
          start_string: 'CM.version = '
      - name: Set up JDK for java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v3
        with:
          java-version: "${{ env.JAVA_VERSION }}"
          distribution: 'temurin'
      - name: Build ShaidyMapGen.jar
        run: |
          cd NGCHM
          ant -f build_shaidyRmapgen.xml
      - name: Build ngchmWidget-min.js
        run: |
          cd NGCHM
          ant -f build_ngchmApp.xml
      - name: Check out NGCHMSupportFiles repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.NGCHMSupportFiles_REPOSITORY }}
          token: ${{ secrets.DQS_DEV_BCB_ACTIONS_TOKEN }}
          ref: ${{ env.NGCHMSupportFiles_BRANCH }}
          path: './NGCHMSupportFiles'
      - name: Copy artifacts to NGCHMSupportFiles and update NGCHMSupportFiles version
        run: |
          cd NGCHMSupportFiles
          cp ../NGCHM/ShaidyMapGen.jar inst/java
          cp ../NGCHM/ngchmWidget-min.js inst/js
          sed -i.bak '/Version:/d' DESCRIPTION
          echo "Version: ${{ steps.get_version_number.outputs.version_number }}" >> DESCRIPTION
          cat DESCRIPTION
      - name: Verify NGCHMSupportFile R build
        run: |
          cd NGCHMSupportFiles
          R CMD build .
      - name: Commit and push update to NGCHMSupportFiles repo
        run: |
          cd NGCHMSupportFiles
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add inst/java/ShaidyMapGen.jar
          git add inst/js/ngchmWidget-min.js
          git add DESCRIPTION
          git commit -m "Update for NG-CHM Release ${{ steps.get_version_number.outputs.version_number }}"
          git push origin ${{ env.NGCHMSupportFiles_BRANCH }}
      - name: Create a release in NGCHMSupportFiles repo
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.DQS_DEV_BCB_ACTIONS_TOKEN }}
          body: "Version ${{ steps.get_version_number.outputs.version_number }}"
          repository: ${{ env.NGCHMSupportFiles_REPOSITORY }}


